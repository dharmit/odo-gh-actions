"use strict";(self.webpackChunkodo_dev=self.webpackChunkodo_dev||[]).push([[284],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>h});var i=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,i,a=function(e,n){if(null==e)return{};var t,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)t=r[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)t=r[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var l=i.createContext({}),c=function(e){var n=i.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},d=function(e){var n=c(e.components);return i.createElement(l.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},u=i.forwardRef((function(e,n){var t=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=c(t),h=a,m=u["".concat(l,".").concat(h)]||u[h]||p[h]||r;return t?i.createElement(m,o(o({ref:n},d),{},{components:t})):i.createElement(m,o({ref:n},d))}));function h(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var r=t.length,o=new Array(r);o[0]=u;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var c=2;c<r;c++)o[c]=t[c];return i.createElement.apply(null,o)}return i.createElement.apply(null,t)}u.displayName="MDXCreateElement"},550:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var i=t(3117),a=(t(7294),t(3905));const r={title:"Binding an external service with odo v3",author:"Philippe Martin",author_url:"https://github.com/feloy",author_image_url:"https://github.com/feloy.png",tags:["binding"],slug:"binding-external-service-with-odo-v3"},o=void 0,s={permalink:"/odo-gh-actions/blog/binding-external-service-with-odo-v3",editUrl:"https://github.com/redhat-developer/odo/edit/main/docs/website/blog/2022-06-14-binding-external-service.md",source:"@site/blog/2022-06-14-binding-external-service.md",title:"Binding an external service with odo v3",description:"How to bind an external service using odo v3",date:"2022-06-14T00:00:00.000Z",formattedDate:"June 14, 2022",tags:[{label:"binding",permalink:"/odo-gh-actions/blog/tags/binding"}],readingTime:6.36,truncated:!0,authors:[{name:"Philippe Martin",url:"https://github.com/feloy",imageURL:"https://github.com/feloy.png"}],frontMatter:{title:"Binding an external service with odo v3",author:"Philippe Martin",author_url:"https://github.com/feloy",author_image_url:"https://github.com/feloy.png",tags:["binding"],slug:"binding-external-service-with-odo-v3"},prevItem:{title:"Binding to a database service without the Service Binding Operator",permalink:"/odo-gh-actions/blog/binding-database-service-without-sbo"},nextItem:{title:"odo v3-alpha1 Released",permalink:"/odo-gh-actions/blog/odo-v3-alpha1-release"}},l={authorsImageUrls:[void 0]},c=[{value:"Creating a Service resource to redirect to the external service",id:"creating-a-service-resource-to-redirect-to-the-external-service",level:2},{value:"Storing the credentials into a Secret resource",id:"storing-the-credentials-into-a-secret-resource",level:2},{value:"Adding SBO Annotations to the Service resource",id:"adding-sbo-annotations-to-the-service-resource",level:2},{value:"Adding a ServiceBinding to the Devfile",id:"adding-a-servicebinding-to-the-devfile",level:2},{value:"Using the variables into the application&#39;s code",id:"using-the-variables-into-the-applications-code",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}],d={toc:c};function p(e){let{components:n,...t}=e;return(0,a.kt)("wrapper",(0,i.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"How to bind an external service using odo v3"),(0,a.kt)("p",null,"When developers are working on a micro-service that needs to access a database or another service,\nthey may want to provide to their application the address and the necessary credentials to access\nthis service as simply as possible."),(0,a.kt)("p",null,"In this article, we are going to talk about ",(0,a.kt)("em",{parentName:"p"},"binding")," the service to the application."),(0,a.kt)("p",null,"Using the Service Binding Operator and creating some Kubernetes resources for\neach service you want to bind to, you can make the life easier for developers."),(0,a.kt)("h2",{id:"creating-a-service-resource-to-redirect-to-the-external-service"},"Creating a Service resource to redirect to the external service"),(0,a.kt)("p",null,"To expose an external service from inside a Kubernetes cluster, you can create a ",(0,a.kt)("em",{parentName:"p"},"Headless")," Service,\nand manually create the Endpoints to access this external service."),(0,a.kt)("p",null,"Here is an example, to connect to an external Redis service on IP 192.168.1.10 and port 6379:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"kind: Service\napiVersion: v1\nmetadata:\n  name: redis\n  namespace: external-services\nspec:\n  type: ClusterIP\n  ports:\n  - port: 6379\n    targetPort: 6379\n\n---\n\nkind: Endpoints\napiVersion: v1\nmetadata:\n  name: redis\n  namespace: external-services\nsubsets:\n- addresses:\n  - ip: 192.168.1.10\n  ports:\n  - port: 6379\n")),(0,a.kt)("p",null,"Note that we have created these resources in a ",(0,a.kt)("inlineCode",{parentName:"p"},"external-services")," namespace, which is a dedicated namespace\nto store external services information, accessible by all developers."),(0,a.kt)("p",null,"You can find more information about creating Service resources to access external services ",(0,a.kt)("a",{parentName:"p",href:"https://docs.openshift.com/dedicated/3/dev_guide/integrating_external_services.html"},"here")," or ",(0,a.kt)("a",{parentName:"p",href:"https://www.youtube.com/watch?v=fvpq4jqtuZ8"},"here"),"."),(0,a.kt)("h2",{id:"storing-the-credentials-into-a-secret-resource"},"Storing the credentials into a Secret resource"),(0,a.kt)("p",null,"The Redis instance is protected by a password, and you may want to store this password into a Secret resource,\nso it can be used by applications."),(0,a.kt)("p",null,"The developers may want to ",(0,a.kt)("em",{parentName:"p"},"mount")," this Secret into their application's Pod, but Secrets are mountable only\nfrom Pods in the same namespace, and you would like to share these credentials with all the developers\nof the team, without creating several instances of this Secret (one in each developer's namespace), but only one\nin the ",(0,a.kt)("inlineCode",{parentName:"p"},"external-services")," namespace."),(0,a.kt)("p",null,"Here is, as an example, the secret to store the Redis password."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"kind: Secret\napiVersion: v1\nmetadata:\n  name: redis-credentials\n  namespace: external-services\nstringData:\n  password: MyEasyPassword\n")),(0,a.kt)("h2",{id:"adding-sbo-annotations-to-the-service-resource"},"Adding SBO Annotations to the Service resource"),(0,a.kt)("p",null,"To be able to ",(0,a.kt)("em",{parentName:"p"},"mount")," the values of this secret from any namespace, you can use the ",(0,a.kt)("em",{parentName:"p"},"Service Binding Operator")," (SBO for short), so each developer can define a ServiceBinding resource\nbetween the service and its application, and get the values of the secret (and other values) mounted into its application's Pod."),(0,a.kt)("p",null,"You can find information about the Service Binding Operator ",(0,a.kt)("a",{parentName:"p",href:"/docs/overview/cluster-setup/kubernetes"},"here"),"."),(0,a.kt)("p",null,"A ServiceBinding defines a binding between an ",(0,a.kt)("em",{parentName:"p"},"Application")," and a ",(0,a.kt)("em",{parentName:"p"},"Service"),". The credentials injected into the application\ncan be defined in different ways:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"if the service is an Operator-backed service running on the cluster, the details of the injected credentials can be set\nas annotations of the CRD associated with the Operator-backed service,"),(0,a.kt)("li",{parentName:"ul"},"in any case, the details of the injected credentials can be set in the resource itself (not the CRD). "),(0,a.kt)("li",{parentName:"ul"},"in any case, the details of the injected credentials can be set in the ServiceBinding resource itself.")),(0,a.kt)("p",null,"In this article, we are not using an Operator-backed service, but an external service referenced by a Service resource.\nAs the Service resource is a native Kubernetes resource, we cannot add annotations to its CRD, so we will add annotations to\nthe Service resource itself."),(0,a.kt)("p",null,"You can modify the definition of the Service, by adding the following annotations:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"kind: Service\napiVersion: v1\nmetadata:\n  name: redis\n  annotations:\n    service.binding/host: path={.metadata.name}.{.metadata.namespace}.svc.cluster.local\n    service.binding: path={.metadata.name}-credentials,objectType=Secret\nspec:\n  type: ClusterIP\n  ports:\n  - port: 6379\n    targetPort: 6379\n")),(0,a.kt)("p",null,"In this snippet, the first annotation"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"service.binding/host: path={.metadata.name}.{.metadata.namespace}.svc.cluster.local\n")),(0,a.kt)("p",null,"indicates to the SBO to inject a ",(0,a.kt)("inlineCode",{parentName:"p"},"host")," variable into the application, with a value computed based on the\n",(0,a.kt)("inlineCode",{parentName:"p"},"metadata.name")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"metadata.namespace")," of the Service resource. In this example, the value ",(0,a.kt)("inlineCode",{parentName:"p"},"redis.external-services.svc.cluster.local"),"\nwill be given to the ",(0,a.kt)("inlineCode",{parentName:"p"},"host")," variable."),(0,a.kt)("p",null,"The second annotation"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"service.binding: path={.metadata.name}-credentials,objectType=Secret\n")),(0,a.kt)("p",null,"indicates to the SBO to inject the values defined in the Secret, whose name is the name of the Service resource\nfollowed by ",(0,a.kt)("inlineCode",{parentName:"p"},"-credentials")," (",(0,a.kt)("inlineCode",{parentName:"p"},"redis-credentials")," in our example), into the application. In this example, the variable ",(0,a.kt)("inlineCode",{parentName:"p"},"password"),"\nwith a value ",(0,a.kt)("inlineCode",{parentName:"p"},"MyEasyPassword")," will be injected into the application's Pod."),(0,a.kt)("h2",{id:"adding-a-servicebinding-to-the-devfile"},"Adding a ServiceBinding to the Devfile"),(0,a.kt)("p",null,"To define a ServiceBinding, we need information (group, version, kind, name, and namespace) about the Application and the Service."),(0,a.kt)("p",null,'In our example, the service is a Kubernetes Service (group "", version "v1" and kind "Service") named ',(0,a.kt)("inlineCode",{parentName:"p"},"redis"),"\nin the ",(0,a.kt)("inlineCode",{parentName:"p"},"external-services")," namespace."),(0,a.kt)("p",null,'The application will be the Deployment resource (group "apps", version "v1", kind "Deployment") created by odo when you run ',(0,a.kt)("inlineCode",{parentName:"p"},"odo dev"),".\nBy convention, the Deployment name will be the name of the Devfile (in the ",(0,a.kt)("inlineCode",{parentName:"p"},".metadata.name")," field) followed by ",(0,a.kt)("inlineCode",{parentName:"p"},"-app")," (",(0,a.kt)("inlineCode",{parentName:"p"},"my-nodejs-app-app")," in our example).\nYou don't have to specify the namespace, as the Deployment will be in the same namespace as the ServiceBinding."),(0,a.kt)("p",null,"The option ",(0,a.kt)("inlineCode",{parentName:"p"},"bindAsFiles")," indicates to the SBO to create files into the Pod's container, each file having the name\nof a credential, and containing the value of the credential."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: binding.operators.coreos.com/v1alpha1\nkind: ServiceBinding\nmetadata:\n  name: binding-to-redis\nspec:\n  application:\n    group: apps\n    version: v1\n    kind: Deployment\n    name: my-nodejs-app-app\n  services:\n  - group: ""\n    version: v1\n    kind: Service\n    name: redis\n    namespace: external-services\n  bindAsFiles: true\n')),(0,a.kt)("p",null,"You can create a file ",(0,a.kt)("inlineCode",{parentName:"p"},"kubernetes/redis.yaml")," in your directory containing this snippet,\nand add a Kubernetes component into your Devfile referring to this YAML file:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"metadata:\n  name: my-nodejs-app\n[...]\ncomponents:\n[...]\n- name: binding-to-redis\n  kubernetes:\n    uri: kubernetes/redis.yaml\n")),(0,a.kt)("p",null,"By adding this Kubernetes component to your Devfile, when you run ",(0,a.kt)("inlineCode",{parentName:"p"},"odo dev"),", the ServiceBinding resource defined\nin the ",(0,a.kt)("inlineCode",{parentName:"p"},"kubernetes/redis.yaml")," file will be created into the cluster, and the Service Binding Operator will inject\ninto the application's Pod the ",(0,a.kt)("inlineCode",{parentName:"p"},"host")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"password")," necessary to connect to the Redis external service."),(0,a.kt)("h2",{id:"using-the-variables-into-the-applications-code"},"Using the variables into the application's code"),(0,a.kt)("p",null,"The Devfile is now ready, and the developer can start accessing the external service from the code. "),(0,a.kt)("p",null,"The first step to know how the credentials are exposed into the application's container is to start the ",(0,a.kt)("inlineCode",{parentName:"p"},"odo dev"),"\ncommand and to execute the ",(0,a.kt)("inlineCode",{parentName:"p"},"odo describe binding")," command."),(0,a.kt)("p",null,"Running ",(0,a.kt)("inlineCode",{parentName:"p"},"odo dev"),", you can see that the ServiceBinding resource is deployed to the cluster."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"$ odo dev\n[...]\n\u21aa Deploying to the cluster in developer mode\n \u2713  Creating kind ServiceBinding [60ms]\n \u2713  Waiting for Kubernetes resources [10s]\n \u2713  Syncing files into the container [740ms]\n \u2713  Building your application in container on cluster [4s]\n \u2713  Executing the application [1s]\n[...]\n")),(0,a.kt)("p",null,"From another terminal, running ",(0,a.kt)("inlineCode",{parentName:"p"},"odo describe binding")," will show you the status of the ServiceBinding:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"$ odo describe binding\nServiceBinding used by the current component:\n\nService Binding Name: binding-to-redis\nServices:\n \u2022  redis (Service.)\nBind as files: true\nDetect binding resources: false\nAvailable binding information:\n \u2022  ${SERVICE_BINDING_ROOT}/binding-to-redis/host\n \u2022  ${SERVICE_BINDING_ROOT}/binding-to-redis/password\n")),(0,a.kt)("p",null,"This output shows that two files ",(0,a.kt)("inlineCode",{parentName:"p"},"host")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"password")," are present in the application's container, at the mentioned paths."),(0,a.kt)("p",null,"You can leverage a servicebinding library to help you access\nthese files. A complete list of libraries is available on the page ",(0,a.kt)("a",{parentName:"p",href:"https://servicebinding.io/application-developer/"},"Service Bindings for Application Developers"),"."),(0,a.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,a.kt)("p",null,"If the output of ",(0,a.kt)("inlineCode",{parentName:"p"},"odo describe binding")," shows an unknown status:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Available binding information: unknown\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"first check if ",(0,a.kt)("inlineCode",{parentName:"li"},"odo dev")," is still running. ",(0,a.kt)("inlineCode",{parentName:"li"},"odo")," is not able to know\nthe bound credentials if the ServiceBinding resource is not deployed by ",(0,a.kt)("inlineCode",{parentName:"li"},"odo dev"),"."),(0,a.kt)("li",{parentName:"ul"},"if ",(0,a.kt)("inlineCode",{parentName:"li"},"odo dev")," is running, you can check that the ServiceBinding resource is deployed to the cluster, and if its status is ",(0,a.kt)("inlineCode",{parentName:"li"},"ApplicationsBound"),", with the command:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"kubectl get servicebindings.binding.operators.coreos.com\n"))),(0,a.kt)("li",{parentName:"ul"},"if the status of the ServiceBinding resource displayed in the list is not ",(0,a.kt)("inlineCode",{parentName:"li"},"ApplicationsBound"),", you can get an error message with the command:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"kubectl describe servicebindings.binding.operators.coreos.com <service-binding-name>\n")))))}p.isMDXComponent=!0}}]);